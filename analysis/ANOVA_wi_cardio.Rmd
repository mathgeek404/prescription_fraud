---
title: "anova_wi_cardio"
author: "Sahit Mandala"
date: "Sunday, December 06, 2015"
output: pdf_document
---
# Calculates the ratio statistics across all drugs

#Note: While the metric of brand_name != generic_name is generally affective, there are some 
# outliers to consider, such as when a substring of the total name is used as "brand name"

```{r}
library(data.table)
library(dplyr)
library(agricolae)
setwd("~/projects/data")
b= c(rep("character", 6),rep("factor",4), "numeric", rep("factor",6), "character", "character", "character", "numeric", rep("character",2), "factor", "character", "factor", "character", rep("character", 10), rep("factor", 6))
DT = fread("National_Downloadable_File.csv",colClasses = b)
names(DT)[1] <- c("NPI")
setkey(DT, NPI)

phy_drugs = fread("wi_cardi2.tab", sep="\t", header=FALSE)
hospitals = unique(phy_drugs[, 20])
setkey(phy_drugs,V1)

#Change to focus on METOPROLOL SUCCINATE b/g ratio
if (FALSE) {
  phy_drugs = phy_drugs[`V9`=="METOPROLOL SUCCINATE"]
}

```

#First aggregate ratios over physicians 

```{r}
grouped_by_physician = phy_drugs %>% 
  group_by(V1) %>%
  select(drug_name = V8, generic_name = V9, total_claim_cnt = V11) 
```


#Calculates ratios based on number of brand name vs total claims, adds respective hospital to each row
```{r}

phy_bg_ratios = summarise(grouped_by_physician, 
      bg_ratio = (sum(as.vector(total_claim_cnt[as.vector(drug_name) != as.vector(generic_name)]))/sum(as.vector(total_claim_cnt)))
)

phy_bg_ratios$hospital <- phy_drugs[.(phy_bg_ratios$V1), mult = "first"]$V20
phy_bg_ratios$zip = DT[.(as.character(phy_bg_ratios$V1)), mult = "first"]$`Zip Code`
```
# ANOVA analysis on Wisconsin on b/g ratio

```{r}


```

# ANOVA analysis by hospital on b/g ratio

```{r}
data <-phy_bg_ratios
data <- cbind(data,trt=factor(data$hospital,labels=1:length(unique(data$hospital))))
model <- aov(bg_ratio ~ trt, data = data)

lsd.out <- LSD.test(model, "trt", p.adj = "bonferroni")
hsd.out <- HSD.test(model,"trt", group = T)

bar.group(lsd.out$groups,ylim=c(0,1),density=4,border="blue")
bar.group(hsd.out$groups,ylim=c(0,1),density=4,border="blue")

#lsd.out$groups
#hsd.out$groups

id.group <- data %>% 
  select(hospital, trt) %>%
  unique()
hsd.out$groups.id <- merge(id.group, hsd.out$groups, by = "trt")
hsd.out$groups.id

```

# ANOVA analysis by zipcode on b/g ratio

```{r}
data <-phy_bg_ratios
data <- cbind(data,trt=factor(data$zip,labels=1:length(unique(data$zip))))
model <- aov(bg_ratio ~ trt, data = data)

lsd.out <- LSD.test(model, "trt", p.adj = "bonferroni")
hsd.out <- HSD.test(model,"trt", group = T)

bar.group(lsd.out$groups,ylim=c(0,1),density=4,border="blue")
bar.group(hsd.out$groups,ylim=c(0,1),density=4,border="blue")

#lsd.out$groups
#hsd.out$groups

id.group <- data %>% 
  select(hospital, trt) %>%
  unique()
hsd.out$groups.id <- merge(id.group, hsd.out$groups, by = "trt")
hsd.out$groups.id

```

##Miscelaneous codes
```{r}
#grouped_by_hospital = phy_bg_ratios %>% 
#  group_by(hospital) %>%
#  select(ratio = bg_ratio) 

#Calculates ratios based on number of brand name vs total claims
# hosp_bg_ratios = summarise(grouped_by_hospital, 
#       average_ratio = mean(ratio),
#       ratio_std = sd(ratio)
#       )
#    
#hist(hosp_bg_ratios$average_ratio)
#hist(hosp_bg_ratios$ratio_std/hosp_bg_ratios$average_ratio)

```


