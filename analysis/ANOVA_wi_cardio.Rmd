---
title: "anova_wi_cardio"
author: "Sahit Mandala"
date: "Sunday, December 06, 2015"
output: pdf_document
---
# Calculates the ratio statistics across all drugs

#Note: While the metric of brand_name != generic_name is generally affective, there are some 
# outliers to consider, such as when a substring of the total name is used as "brand name"

```{r}
library(data.table)
library(dplyr)
library(agricolae)
setwd("~/projects/data")
b= c(rep("character", 6),rep("factor",4), "numeric", rep("factor",6), "character", "character", "character", "numeric", rep("character",2), "factor", "character", "factor", "character", rep("character", 10), rep("factor", 6))
DT = fread("National_Downloadable_File.csv",colClasses = b)
names(DT)[1] <- c("NPI")
setkey(DT, NPI)
DT_wi = DT[State == "WI"]

#phy_drugs = fread("wi_cardi2.tab", sep="\t", header=FALSE)
cc = c(rep("character",10),"numeric",rep("character",8))
phy_drugs = fread("wi_card_all.txt", sep=",", colClasses = cc)
hospitals = unique(phy_drugs[, 20])
setkey(phy_drugs,NPI)

#Change to focus on METOPROLOL SUCCINATE b/g ratio
if (TRUE) {
  phy_drugs = phy_drugs[`GENERIC_NAME`=="METOPROLOL SUCCINATE"]
}

```

#First aggregate ratios over physicians 

```{r}
grouped_by_physician = phy_drugs %>% 
  group_by(NPI) %>%
  select(drug_name = DRUG_NAME, generic_name = GENERIC_NAME, total_claim_cnt = TOTAL_CLAIM_COUNT) 
```


#Calculates ratios based on number of brand name vs total claims, adds respective hospital to each row
```{r}

phy_bg_ratios = summarise(grouped_by_physician, 
      bg_ratio = (sum(as.vector(total_claim_cnt[as.vector(drug_name) != as.vector(generic_name)]))/sum(as.vector(total_claim_cnt)))
)

phy_bg_ratios$hospital <- DT_wi[phy_bg_ratios$NPI, mult = "first"]$`Organization DBA name`
phy_bg_ratios$zip = DT_wi[phy_bg_ratios$NPI, mult = "first"]$`Zip Code`
phy_tmp = phy_bg_ratios
phy_bg_ratios = phy_bg_ratios[!is.na(phy_bg_ratios$hospital) & !(phy_bg_ratios$hospital=="") ]
```
# ANOVA analysis on Wisconsin on b/g ratio

```{r}


```

# ANOVA analysis by hospital on b/g ratio

```{r}
data <-phy_bg_ratios
data <- cbind(data,trt=factor(data$hospital,labels=1:length(unique(data$hospital))))
model <- aov(bg_ratio ~ trt, data = data)

lsd.out <- LSD.test(model, "trt", p.adj = "bonferroni")
hsd.out <- HSD.test(model,"trt", group = T)

bar.group(lsd.out$groups,ylim=c(0,1),density=4,border="blue")
bar.group(hsd.out$groups,ylim=c(0,1),density=4,border="blue")

#lsd.out$groups
#hsd.out$groups

id.group <- data %>% 
  select(hospital, trt) %>%
  unique()
hsd.out$groups.id <- merge(id.group, hsd.out$groups, by = "trt")
hsd.out$groups.id

```

# ANOVA analysis by zipcode on b/g ratio

```{r}
data <-phy_bg_ratios
data <- cbind(data,trt=factor(data$zip,labels=1:length(unique(data$zip))))
model <- aov(bg_ratio ~ trt, data = data)

lsd.out <- LSD.test(model, "trt", p.adj = "bonferroni")
hsd.out <- HSD.test(model,"trt", group = T)

bar.group(lsd.out$groups,ylim=c(0,1),density=4,border="blue")
bar.group(hsd.out$groups,ylim=c(0,1),density=4,border="blue")

#lsd.out$groups
#hsd.out$groups

id.group <- data %>% 
  select(hospital, trt) %>%
  unique()
hsd.out$groups.id <- merge(id.group, hsd.out$groups, by = "trt")
hsd.out$groups.id

```

##Miscelaneous codes
```{r}
#grouped_by_hospital = phy_bg_ratios %>% 
#  group_by(hospital) %>%
#  select(ratio = bg_ratio) 

#Calculates ratios based on number of brand name vs total claims
# hosp_bg_ratios = summarise(grouped_by_hospital, 
#       average_ratio = mean(ratio),
#       ratio_std = sd(ratio)
#       )
#    
#hist(hosp_bg_ratios$average_ratio)
#hist(hosp_bg_ratios$ratio_std/hosp_bg_ratios$average_ratio)

```


