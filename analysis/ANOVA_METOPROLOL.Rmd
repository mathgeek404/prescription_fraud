---
title: "ANOVA_METOPROLOL"
author: "Zongyan Wang"
date: "Monday, December 07, 2015"
output: pdf_document
---
## Load package
```{r}
library(data.table)
library(dplyr)
library(agricolae)
library(ggplot2)
```

## data loading and clean
```{r}
phy_drugs = fread("F:/Academic/Stat 992/group project/toy_data/wi_cardi2.tab", sep="\t", header=FALSE)
hospitals = unique(phy_drugs[, 20])
setkey(phy_drugs,V1)
#phy_drugs$zip = DT[as.character(phy_drugs$V1), mult = "first"]$`Zip Code` 
if(T){
  phy_drugs = phy_drugs[`V9`=="METOPROLOL SUCCINATE"]
}


#First aggregate ratios over physicians 
grouped_by_physician = phy_drugs %>% 
  group_by(V1) %>%
  dplyr::select(drug_name = V8, generic_name = V9, total_claim_cnt = V11) 

#Calculates ratios based on number of brand name vs total claims
phy_bg_ratios = dplyr::summarise(grouped_by_physician, 
                          bg_ratio = (sum(as.vector(total_claim_cnt[as.vector(drug_name) != as.vector(generic_name)]))/sum(as.vector(total_claim_cnt)))
)

phy_bg_ratios$hospital <- phy_drugs[.(phy_bg_ratios$V1), mult = "first"]$V20

```




## ANOVA
```{r}
data <-phy_bg_ratios
data <- cbind(data,trt=factor(data$hospital,labels=1:length(unique(data$hospital))))
model <- aov(bg_ratio ~ trt, data = data)
summary(model)
```
The p-value is 7.5 * 10^{-8}, it shows there are significant different among hospital.


## Doing LSD and HSD test
```{r}
lsd.out <- LSD.test(model, "trt", p.adj = "bonferroni")
hsd.out <- HSD.test(model,"trt", group = T)

bar.group(lsd.out$groups,ylim=c(0,45),density=4,border="blue")
bar.group(hsd.out$groups,ylim=c(0,45),density=4,border="blue")

#lsd.out$groups
#hsd.out$groups
```


## You can match the group number with hospital with the data we use
```{r}
id.group <- data %>% 
  dplyr::select(hospital, trt) %>%
  unique()

hsd.out$groups.id <- merge(id.group, hsd.out$groups, by = "trt")
hsd.out$groups.id
```
There are three hospitals stand out, which are EDDY D. CO, MD, SC; JOAN T. HARNEY GNADT, MD, SC; MERCY HEALTH SYSTEM CORPORATION.

## plot 
```{r}
bgmean <- data %>% 
  group_by(trt) %>%
  summarize(bgMean = mean(bg_ratio)) %>%
  mutate(hospital = reorder(x = trt, X = bgMean, min))
ggplot(bgmean, aes(x = hospital, y = bgMean)) +
  geom_point(aes(color = hospital)) +
  ggtitle("b/g ratio over hospitals")
#  geom_text(aes(x = hospital, y = bgMean, label = hospital), size = 2.5)

ggsave(filename = "wi_cardio_METO.png", plot = last_plot())
```
